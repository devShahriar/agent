FROM ubuntu:22.04 as builder

# Avoid prompts from apt
ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    ca-certificates \
    wget \
    git \
    build-essential \
    pkg-config \
    libelf-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Go 1.21
RUN wget -q https://dl.google.com/go/go1.21.0.linux-amd64.tar.gz && \
    tar -C /usr/local -xzf go1.21.0.linux-amd64.tar.gz && \
    rm go1.21.0.linux-amd64.tar.gz

# Add Go to PATH
ENV PATH=$PATH:/usr/local/go/bin
ENV GOPATH=/go
ENV PATH=$PATH:$GOPATH/bin

# Set working directory
WORKDIR /app

# Copy source code
COPY . .

# Initialize go module and install dependencies
RUN go mod init abproxy || true && \
    go mod edit -go=1.21 && \
    go get github.com/cilium/ebpf@v0.11.0 && \
    go get github.com/cilium/ebpf/link@v0.11.0 && \
    go get github.com/cilium/ebpf/perf@v0.11.0 && \
    go get github.com/sirupsen/logrus@v1.9.3 && \
    go get golang.org/x/sys@v0.15.0 && \
    go mod tidy

# Build the agent without trying to generate eBPF code
# This allows development on MacOS where eBPF code generation isn't supported
RUN cd cmd/agent && go build -o ../../abproxy-agent

# Final stage
FROM ubuntu:22.04

# Install runtime dependencies
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
    ca-certificates \
    libelf1 \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY --from=builder /app/abproxy-agent .

# Keep container running for development
CMD ["tail", "-f", "/dev/null"] 